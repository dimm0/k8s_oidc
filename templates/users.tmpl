{{define "body"}}
  <div style="padding: 15px">
    <a href="mailto:{{.MailtoAll}}">Email all</a>

    <div id="jsGrid"></div>
  </div>
{{end}}

{{define "page_css"}}
  <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
  <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" />
{{end}}

{{define "page_js"}}
<!--
apk add nodejs
npm config set unsafe-perm true
npm install -g grunt-cli
grunt
-->
  <script type="text/javascript" src="media/jsgrid.min.js"></script>
  <script language="JavaScript">
    function verifyUser(username, userid, isValid) {
      $.ajax({
        url: "/users",
        type: "POST",
        data: { user: userid, action: isValid?"validate":"unvalidate" },
        success: function(result){
          $("#"+username+"_role").html(result);
          var newButton = '<a class="btn btn-outline-primary" href="JavaScript:verifyUser(\''+username+'\', \''+userid+'\', '+!isValid+')">'+(isValid?'Unvalidate':'Validate')+'</a>';
          console.debug(newButton);
          $("#"+username+"_modif").html(newButton);
        },
        error: function(xhr, text){
          vex.dialog.alert(xhr.responseText)
        },
      });
    }

    $("#jsGrid").jsGrid({
        width: "100%",
	controller: {
            loadData: function(filter) {
		    var d = $.Deferred();
		    $.ajax({url: "/users", dataType: "json", data: {format: "json", action: "general"}}).done(function(response) {
			d.resolve(response);
		    });
		    return d.promise();
	    }
	},
	autoload: true,
	sorting: true,
	selecting: false,
        fields: [
            { title: "User ID", name: "spec.UserID", type: "text", width: 60},
            { title: "Name", name: "spec.Name", type: "text", sorter: "string", width: 30 },
            { title: "IDP", name: "spec.IDP", type: "text", width: 30 },
            { title: "Email", name: "spec.Email", type: "text", width: 45 },
            { title: "Role", name: "spec.Role", type: "text", width: 5 },
            { title: "Validate", type: "checkbox", width: 10},
        ]
    });
  </script>
{{end}}
